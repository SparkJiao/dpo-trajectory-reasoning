This folder records the scripts for the fixed explore from infer experiment since 2023-12-27.

The fixed problem is that during filtering DPO pairwise data, the solution predicting multiple answers, e.g., `The answer is A and B,`, should be filtered out.
This kind of data would make the DPO model prefer to hack the problems by predicting multiple answers.

### Logs

#### Data processing

For logiqa-v2 data, here is the logs for reconstruction the DPO pair data:
```bash
['experiments/llama2.7b.chat.logiqav2.llama-2-70b-chat.dpo-sft.A6K.w4.v1.0/checkpoint-1600//logiqav2-train.full.qa.react.v1.0.0shot.sample10.json']
12567
Clean: 12567 -> 12567
74804
133458
{'invalid': 0, 'missing': 194, 'multiple': 2552, 'wrong': 45888}
data size: 133458
dev_num: 1000
dev size: 1000
train size: 132458
```
from which we can find that the SFT model does not prefer to always generate multiple answers. So we do not run base SFT again.

Rewarding the responses generated by step-DPO model:
```
python scripts/construct_dpo_data_from_react_response.py --input_file /export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.logiqav2.70b-distil.step.dpo.fix_hack.H100.w4.v1.0.s44/checkpoint-1200/logiqav2.react.train.0shot.sample5.v1.0.json --output_file /export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.logiqav2.70b-distil.step.dpo.fix_hack.H100.w4.v1.0.s44/checkpoint-1200/logiqav2.react.train.0shot.sample5.v1.0.clean_dpo_pair.json
['/export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.logiqav2.70b-distil.step.dpo.fix_hack.H100.w4.v1.0.s44/checkpoint-1200/logiqav2.react.train.0shot.sample5.v1.0.json']
12567
Clean: 12567 -> 12563
44822
10421
{'invalid': 0, 'missing': 57, 'multiple': 8, 'wrong': 16484}
```

Similarly, for ReClor:
```bash
['experiments/llama2.7b.chat.mixtral.dpo-sft.A100.40.w8.v1.0/checkpoint-1200/reclor.react.train.0shot.sample10.v1.0.json']
4638
Clean: 4638 -> 4629
19144
46321
{'invalid': 0, 'missing': 265, 'multiple': 2172, 'wrong': 14540}
data size: 46321
dev_num: 1000
dev size: 1000
train size: 45321
```

Re-rewarding the responses generated by DPO model:
```
python scripts/construct_dpo_data_from_react_response.py --input_file /export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.reclor.mixtral.dpo.fix_hack.A100.40.w8.v2.0.s42/reclor.react.train.0shot.sample10.v1.0.json --output_file /export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.reclor.mixtral.dpo.fix_hack.A100.40.w8.v2.0.s42/checkpoint-400/react-inter-states/reclor.react.train.0shot.sample10.v1.0.clean_dpo_pair.json
['/export/home2/fangkai/rl-hybrid-engine/experiments/llama2.7b.chat.reclor.mixtral.dpo.fix_hack.A100.40.w8.v2.0.s42/reclor.react.train.0shot.sample10.v1.0.json']
4638
Clean: 4638 -> 4603
20159
39547
{'invalid': 0, 'missing': 49, 'multiple': 55, 'wrong': 14606}
```

#### Construction data pairs

Logiqa-v2
```bash
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/logiqav2/best_of_filter_full.sh 
(3,)
product
collected rewards 108096
duplicate responses 15276
Reduced 9349
Positive pairs 21831
Candidates: 12560
Collected amount of samples with rewards 155210
Save to experiments/llama2.7b.chat.logiqav2.llama-2-70b-chat.dpo-sft.A6K.w4.v1.0/checkpoint-1600/react-inter-states/../fix_hack_data_dir/logiqav2-train.react.v1.0.0shot.sample10.clean_inter_ver2.0.rs0.2.r0.3.prm_hack_fix_v10_cp800_best_of_10.neg10.pos0.4.v2.2.(3,).pair.product.(3,).full_only.json
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/logiqav2/best_of_filter_full.sh 
(3,)
product
collected rewards 108096
duplicate responses 15276
Reduced 9349
Positive pairs 6363
Candidates: 12560
Collected amount of samples with rewards 139742
Save to experiments/llama2.7b.chat.logiqav2.llama-2-70b-chat.dpo-sft.A6K.w4.v1.0/checkpoint-1600/react-inter-states/../fix_hack_data_dir/logiqav2-train.react.v1.0.0shot.sample10.clean_inter_ver2.0.rs0.2.r0.3.prm_hack_fix_v10_cp800_best_of_10.neg10.pos0.7.v2.2.(3,).pair.product.(3,).full_only.json
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/logiqav2/best_of_filter_full.sh 
(2, 3)
product
collected rewards 108096
duplicate responses 15276
Reduced 9349
Positive pairs 27761
Candidates: 12560
Collected amount of samples with rewards 161140
Save to experiments/llama2.7b.chat.logiqav2.llama-2-70b-chat.dpo-sft.A6K.w4.v1.0/checkpoint-1600/react-inter-states/../fix_hack_data_dir/logiqav2-train.react.v1.0.0shot.sample10.clean_inter_ver2.0.rs0.2.r0.3.prm_hack_fix_v10_cp800_best_of_10.neg10.pos0.5.v2.2.(2,3).pair.product.(2,3).full_only.json
```


Sampling again from DPO-generated data:
```bash
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/reclor/best_of_filter_full.sh 
product
(2,3,4,5)
collected rewards 34334
duplicate responses 538
sc acc 0.03931734715921365
rm acc 0.03931734715921365
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/reclor/best_of_filter_full.sh 
product
(2,3,4,5)
collected rewards 34334
duplicate responses 538
sc acc 0.6461003693243537
rm acc 0.7303932218118618
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/reclor/best_of_filter_full.sh 
(3, 4, 5)
product
collected rewards 34334
duplicate responses 538
Reduced 4286
Positive pairs 230
Candidates: 4603
Collected amount of samples with rewards 39777
Save to experiments/llama2.7b.chat.reclor.mixtral.dpo.fix_hack.A100.40.w8.v2.0.s42/checkpoint-400/react-inter-states//reclor.train.react.v1.0.0shot.sample10.cleaned.prm_v12_cp400_best_of_10.neg10.pos0.5.v2.2.(3,4,5).pair.product.full_only.json
product
(2,3,4,5)
collected rewards 34334
duplicate responses 538
sc acc 0.6461003693243537
rm acc 0.7303932218118618
(base) fangkai@scsehg:~/rl-hybrid-engine$ bash scripts/fixed_explore_from_infer/reclor/best_of_filter_full.sh 
(2, 3, 4, 5)
product
collected rewards 34334
duplicate responses 538
Reduced 4286
Positive pairs 1834
Candidates: 4603
Collected amount of samples with rewards 41381
Save to experiments/llama2.7b.chat.reclor.mixtral.dpo.fix_hack.A100.40.w8.v2.0.s42/checkpoint-400/react-inter-states//reclor.train.react.v1.0.0shot.sample10.cleaned.prm_v12_cp400_best_of_10.neg10.pos0.3.v2.2.(2,3,4,5).pair.product.full_only.json
product
(2,3,4,5)
collected rewards 34334
duplicate responses 538
sc acc 0.6461003693243537
rm acc 0.7303932218118618
```

